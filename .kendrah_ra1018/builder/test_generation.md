# Test Generation & Coverage

**Module:** Builder → Test Generation
**Primary Language:** Python
**Status:** Active

---

## Overview

KENDRAH can automatically generate, execute, and analyze tests for any code it produces or interacts with. Testing is treated as a first-class concern — not an afterthought. Whenever KENDRAH generates a function, class, API, or module, it is capable of producing a corresponding test suite immediately.

---

## Test Generation Pipeline

### Step 1: Code Analysis
KENDRAH reads the target source file and identifies all testable units:
- Functions (including edge cases from type hints and docstrings)
- Class methods
- API endpoints (routes, expected request/response shapes)
- CLI commands and expected outputs

### Step 2: Test Case Planning
For each testable unit, KENDRAH plans:
- **Happy path:** Expected input produces expected output
- **Edge cases:** Empty inputs, boundary values, null/None, large inputs
- **Error cases:** Invalid types, out-of-range values, missing required parameters
- **Integration points:** Mocked dependencies, external service calls

### Step 3: Test Code Generation
Tests are generated using `pytest` by default (with `unittest` as fallback):

```python
# Auto-generated by KENDRAH
import pytest
from src.utils.pagination import paginate

class TestPaginate:
    def test_standard_pagination(self):
        data = list(range(100))
        result = paginate(data, page=1, size=10)
        assert result == list(range(10))

    def test_last_page(self):
        data = list(range(25))
        result = paginate(data, page=3, size=10)
        assert result == [20, 21, 22, 23, 24]

    def test_empty_list(self):
        assert paginate([], page=1, size=10) == []

    def test_page_out_of_range(self):
        data = list(range(5))
        assert paginate(data, page=10, size=10) == []

    def test_invalid_page_number(self):
        with pytest.raises(ValueError):
            paginate([], page=0, size=10)
```

### Step 4: Test Execution
Tests are run immediately after generation:

```bash
pytest tests/ --tb=short --cov=src --cov-report=term-missing
```

### Step 5: Coverage Analysis
KENDRAH parses coverage output and:
- Identifies untested lines and branches
- Flags functions with zero test coverage
- Recommends additional test cases for uncovered paths

### Step 6: Fix & Retry
If tests fail after generation:
- KENDRAH analyzes the failure output
- Determines if the test or the source code is wrong
- Applies the appropriate fix
- Re-runs the test suite
- Logs the resolution

---

## Test Types Supported

| Type                  | Framework         | When Generated                                     |
|-----------------------|-------------------|----------------------------------------------------|
| Unit Tests            | pytest / unittest | Every function or class method                     |
| Integration Tests     | pytest            | API routes, database interactions, service calls   |
| End-to-End Tests      | Playwright / Selenium | Web app user flows, browser interactions        |
| CLI Tests             | pytest + subprocess | Command-line tool input/output validation        |
| Performance Tests     | locust / timeit   | On request for throughput or latency testing       |
| Security Tests        | bandit            | Scans for common security anti-patterns in code    |

---

## Test File Naming Convention

| Source File                    | Test File                          |
|--------------------------------|------------------------------------|
| `src/api/users.py`             | `tests/api/test_users.py`          |
| `src/utils/pagination.py`      | `tests/utils/test_pagination.py`   |
| `src/models/user.py`           | `tests/models/test_user.py`        |

---

## Coverage Targets

| Context               | Minimum Coverage Target |
|-----------------------|-------------------------|
| Core business logic   | 90%                     |
| API routes            | 85%                     |
| Utility functions     | 80%                     |
| Scripts               | 70%                     |

KENDRAH will flag any module below its target and suggest additional tests.

---

## Mock & Fixture Support

KENDRAH generates mocks for:
- External API calls (`unittest.mock`, `responses` library)
- Database connections (`pytest-mock`, SQLAlchemy in-memory SQLite)
- File system operations (temporary directories via `tmp_path` fixture)
- Time-dependent functions (`freezegun`)

---

## Commands

```
/generate tests [file]          — Generate tests for a specific file
/run tests                      — Run the full test suite
/run tests --file [file]        — Run tests for one file
/coverage                       — Show full coverage report
/coverage --fix                 — Generate tests to close coverage gaps
```
